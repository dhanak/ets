<%doc> This is a -*- mason -*- template.
Change password for current user.
</%doc>

<%args>
$password
$confirm
</%args>

<%once>
use utf8;
my ($log, $sth, $lines);

sub valid_pass {
    my ($pwd) = @_;

    $pwd = uc $pwd;
    if (length $pwd < 6) {
	$data->{MSG} = "<span class=bad>Túl rövid jelszó!</span>";
	return 0;
    }
    if ($pwd =~ /$log/ || $log =~ /$pwd/) {
	$data->{MSG} = "<span class=bad>Hibás jelszó!</span>";
	return 0;
    }
    if ((scalar reverse $pwd) =~ /$log/ ||
	(scalar reverse $log) =~ /$pwd/) {
	$data->{MSG} = "<span class=bad>Hibás jelszó!</span>";
	return 0;
    }

    return 1;
}
</%once>

<%init>;
$log = $data->{NEPTUN};

if (!defined $sth) {
    $sth = $dbh->prepare("UPDATE people SET password=? WHERE neptun=?");
}

if ($password ne $confirm) {
    $data->{MSG} = "<span class=bad>A jelszó eltér a megerősítésétől!</span>";
} elsif (valid_pass($password)) {
    $lines = $sth->execute($password, $log);
    if ($lines != 1) {
	$data->{MSG} = "<span class=bad>A jelszót nem sikerült módosítani.</span>";
    } else {
	$data->{MSG} = "<span class=good>Jelszó módosítva.</span>";
	$m->comp('/sub/log', "change password");
    }
}

redirect($data->{SCREEN}, neptun => $log);
</%init>
