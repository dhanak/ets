<%doc> This is a -*- mason -*- template.
Perform change of email if provided key is correct.  Also set password to
key if it is unset and log user in.
</%doc>

<%args>
$neptun
$email
$password
$hash
</%args>

<%once>;
my ($chg_email, $get_pwd, $set_pwd, $oldpwd, $setnewpwd);
</%once>

<%init>;
if (!defined $chg_email) {
    $chg_email = $dbh->prepare("UPDATE people SET email=? WHERE neptun=?");
    $get_pwd = $dbh->prepare("SELECT password FROM people WHERE neptun=?");
    $set_pwd = $dbh->prepare("UPDATE people SET email=?, password=? WHERE neptun=?");
}

$get_pwd->execute($neptun);
($oldpwd) = $get_pwd->fetchrow_array;
$get_pwd->finish;

$setnewpwd = !defined $data->{NEPTUN} && $oldpwd eq "";

if ($hash eq  crypt($email. $password, $password)) {
    if ($setnewpwd) {
	#
	# First time login
	#
	if ($set_pwd->execute($email, $password, $neptun)) {
	    $data->{MSG} = "<span class=good>Sikeres első belépés. Üdvözöllek az ETS-ben!</span>";	
	    $m->comp('/sub/log', "first login");
	} else {
	    $data->{MSG} = "<span class=bad>Az adatbázist nem sikerült módosítanom.</span>";
	}
	$data->{SCREEN} = "news";

	redirect("action_login", neptun => $neptun, pass => $password);

    } elsif ($m->comp('/sub/check_perm', item => "change_email", neptun => $neptun)) {
	#
	# E-mail change only
	#
	if ($chg_email->execute($email, $neptun)) {
	    $data->{MSG} = "<span class=good>Az e-mail cím módosítása sikerült.</span>";
	    $m->comp('/sub/log', "change e-mail", to => $email);
	} else {
	    $data->{MSG} = "<span class=bad>Az e-mail cím módosítása nem sikerült.</span>";
	}

	redirect("user_details", neptun => $data->{NEPTUN});

    } else {
	$data->{MSG} = "Erre nem vagy jogosult!";
    }
} else {
    if ($setnewpwd) {
	$data->{MSG} = "<span class=bad>A megadott jelszó nem stimmel.</span>";	
	$setnewpwd = 0;
    } elsif ($m->comp('/sub/check_perm', item => "user_details", neptun => $neptun)) {
	$data->{MSG} = "<span class=bad>A megadott kulcs nem egyezik.</span>";
	redirect("user_details", neptun => $data->{NEPTUN});
    }
}

redirect("news");
</%init>
