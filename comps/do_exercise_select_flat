<%doc> This is a -*- mason -*- template.
Offer selection of a category and a specific example ID to administrators.
</%doc>

<%args>
$limit				# the ID of the last chapter to be listed
</%args>

<TABLE width="70%">
<TR><TH>Hét<TH>Témakör<TH>Feladatok
% while (defined ($cat = $sth->fetchrow_hashref)) {
<& TR, \$row &>
<TD align=center><% $cat->{chapter} %>
<TD><& link, text   => $cat->{name},
             href   => "action_do_exercise",
             params => {category => $cat->{category}} &>
<TD align=center><% $cat->{size} %>
% }
</TABLE>

<%once>;
my ($sth, $cat, $row);
</%once>

<%init>;
if (!defined $sth) {
    $sth = # fetch categories
	$dbh->prepare("SELECT categories.id AS category, name, chapter,
                              COUNT(data) AS size
                       FROM categories LEFT JOIN exercises
                       ON categories.id = exercises.category
                       WHERE chapter <= ?
                       GROUP BY categories.id
                       HAVING size > 0
		       ORDER BY chapter, category");
}

$sth->execute($limit);
$row = 0;
</%init>

<%cleanup>;
$sth->finish;
</%cleanup>
