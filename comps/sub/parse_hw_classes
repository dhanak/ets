<%doc> This is a -*- mason -*- template.
Parse GUTS submission configuration file.  Requires the relative path (to
$ENV{GUTS_WORK_DIR}) of the configuration file in the 'conf' parameter, and
returns a pointer to an array of hashes.
</%doc>

<%args>
$conf => "env/submit.conf"
</%args>

<& html_page &>

<%once>;
use open ':encoding(UTF-8)';

my ($output, $semester, $classes);
</%once>

<%init>;
$classes = [];
if (open FILE, "$ENV{GUTS_WORK_DIR}/$conf") {
    while (<FILE>) {
        chomp;
        if (/^semester\(('?)(.*)\g1\)\.$/) {
            $semester = $2;
        } elsif (/^testclass\(
                        ('?)(.*?)\g1,\s*           # class
                        ('?)(.*?)\g3,\s*           # name
                        ('?)(.*?)\g5,\s*           # suite
                        date\((.+),(.+),(.+)\),\s* # begin
                        date\((.+),(.+),(.+)\),\s* # end
                        (\[[^]]*\])                # opts
                  \).$/x) {
            my $class = {
                semester => $semester,
                class => $2,
                name  => $4,
                suite => $6,
                start => sprintf("%4d-%02d-%02d", $7, $8, $9),
                end   => sprintf("%4d-%02d-%02d", $10, $11, $12),
                opts  => $13,
                ()#$13 =~ /file\((.+?)\)/ ? (file => $1) : ()
            };
            $class->{file} = $2 if ($class->{opts} =~ /file\(('?)(.+?)\g1\)/);
            push @$classes, $class;
        }
    }
}
return $classes;
</%init>
