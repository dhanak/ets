<%doc> This is a -*- mason -*- template.
Parse GUTS submission configuration file.  Requires the relative path (to
$ENV{ETS_ROOT}) of the configuration file in the 'conf' parameter, and
returns a pointer to an array of hashes.
</%doc>

<%args>
$conf
</%args>

<& html_page &>

<%once>;
my ($plscript, $output, $classes, @params);
</%once>

<%init>;
$classes = [];

$plscript = <<EOF;
semester(Semester), !,
testclass(Class, Name, Suite, Begin, End, Opts),
format('~w%%~w%%~w%%~w%%~w%%~w%%~w~n', [Semester,Class,Name,Suite,Begin,End,Opts]),
fail.
EOF

($output) = runcmd($ENV{SICSTUS} . " -l " . "$ENV{ETS_ROOT}/$conf",
		   $plscript);

foreach (split /^/m, $output) {
    chomp;
    @params = split /%%/;
    push @$classes,
    {
	semester => $params[0],
	class => $params[1],
	name  => $params[2],
	suite => $params[3],
	start => sprintf("%4d-%02d-%02d", $params[4] =~ /date\((.+),(.+),(.+)\)/),
	end   => sprintf("%4d-%02d-%02d", $params[5] =~ /date\((.+),(.+),(.+)\)/),
	opts  => $params[6],
	$params[6] =~ /file\((.+?)\)/ ? (file => $1) : ()
    };
}

return $classes;
</%init>
