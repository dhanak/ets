<%doc> This is a -*- mason -*- template.
Select an exercise from category $data->{CATEGORY} by random.
If $data->{CATEGORY} is undefined, jump to category selection page.
$data->{CATEGORY} may be a regexp to be matched against.
</%doc>

<%args>
$level => "%"			# matches anything
</%args>

<%once>;
my ($select_exercise, $exid);
</%once>

<%init>;
if (!defined $select_exercise) {
  if (substr($data->{CATEGORY},0,2) eq "PG") {
    $select_exercise = # select an exercise sequentially, by the id field
	$dbh->prepare('SELECT exercises.id FROM exercises LEFT JOIN complete
                       ON exercises.id=complete.exercise AND
                          complete.neptunSID=?
                       WHERE exercises.category REGEXP ? AND
                             level LIKE ?
                       ORDER BY COALESCE(complete.count, 0), exercises.id
                       LIMIT 1');
    $m->comp('/sub/log', "select exercise seq", category =>
	     $data->{CATEGORY},
	     id => $select_exercise);
    }
  else {
    $select_exercise = # select an exercise by random
	$dbh->prepare('SELECT exercises.id FROM exercises LEFT JOIN complete
                       ON exercises.id=complete.exercise AND
                          complete.neptunSID=?
                       WHERE exercises.category REGEXP ? AND
                             level LIKE ?
                       ORDER BY COALESCE(complete.count, 0), RAND()
                       LIMIT 1');
    $m->comp('/sub/log', "select exercise rand", category =>
	     $data->{CATEGORY},
	     id => $select_exercise);
    }
}

if (defined $data->{CATEGORY}) {
    $select_exercise->execute($data->{NEPTUN} || $sid, $data->{CATEGORY}, $level);
    ($exid) = $select_exercise->fetchrow_array;
    $select_exercise->finish;
    $data->{EXID} = $exid;
} else {
    $data->{SCREEN} = "do_exercise_select";
}
</%init>
