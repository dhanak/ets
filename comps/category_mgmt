<%doc> This is a -*- mason -*- template.
List categories, offer deletion and adding.
</%doc>
<%attr>
window_js => 1
</%attr>

<h3 class="topic">Témakörök</h3>

<TABLE width="100%">
<TR>
<TH width="10%">ID
<TH width="10%">Hét
<TH width="68%">Témakör megnevezése
<TH colspan=2>Feladatok
<TH>

% while (defined ($cat = $sth->fetchrow_hashref)) {
<& TR, \$row &>
<TD><% $cat->{category} %>
<TD align=center><% $cat->{chapter} %>
<TD><% $cat->{name} %>
<TD width="7%" align=center><% $cat->{size} %>

<TD align=center>
% if ($cat->{size} > 0) {
<& link, href=>"action_show_page", img => "list.png", text=> "Listáz",
	 params => { page => "list_category", category => $cat->{category} } &>
% }
<TD align=center>
<& js_confirm, text => "Töröl", img => "delete.png", 
    question => "Biztosan törölni akarod a '$cat->{name}' témakört?",
    action => "action_delete_category", hidden => { category => $cat->{category} },
    options => $cat->{size} ? { wipe => "a benne lévő feladatokkal együtt" } : {} &>
% }

<& TR, \$row &>
<& form, action => "action_add_category" &>
<TD><INPUT TYPE=text NAME=id SIZE=6 maxlength=4>
<TD align=center>
<SELECT NAME=chapter>
% foreach (1..14, 99) {
<OPTION><% $_ %></OPTION>
% }
</SELECT>
<TD><INPUT TYPE=text NAME=name SIZE=50>
<TD colspan=3 align=center><INPUT TYPE=submit NAME=submit VALUE="Felvesz">
</FORM>

</TABLE>

<%once>
my ($sth, $cat, $row);
</%once>

<%init>;
if (!defined $sth) {
    $sth = $dbh->prepare("SELECT categories.id AS category, name, chapter,
                                 COUNT(data) AS size
                          FROM categories LEFT JOIN exercises
                          ON categories.id=exercises.category
                          GROUP BY categories.id
		          ORDER BY chapter, category");
}

$sth->execute;
$row = 0;
</%init>

<%cleanup>
$sth->finish;
</%cleanup>
