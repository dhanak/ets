<%doc> This is a -*- mason -*- template.
Produce a form to add an exercise using scheme $data->{SCHEME}.
Offer $data->{CATEGORY} and $data->{LEVEL} as default selection.
Use $data->{EXDATA} to fill the form initially.  $data->{FORM} is
either 'add' or 'modify', the type of the form.  If $data->{EXID}
is defined, it is included in the form as a hidden field.  If
$data->{ERROR} is defined, it is printed before the form.
</%doc>
<%attr>
prototype_js => 1
</%attr>

% if ($data->{FORM} eq 'add') {
<h3 class="topic">Feladat felvétele</h3>
% } else {
<h3 class="topic">Feladat módosítása</h3>
% }

% if (defined $data->{ERROR}) {
<div class="error"><% $data->{ERROR} %></div>
% delete $data->{ERROR}
% }
<P>
% if ($data->{FORM} eq 'add') {
Add meg az új feladat paramétereit:
% } else {
Módosítsd a feladat paramétereit:
% }
<P>

<& form, name => 'exercise', action => "action_$data->{FORM}_exercise",
    hidden => { (defined $data->{EXID}
		 ? (exid => $data->{EXID}, origcat => $data->{CATEGORY})
		 : ()) } &>
<TABLE>
<TR><TD>Témakör:<TD><SELECT name="category">
% while (defined ($i = $get_categories->fetchrow_hashref)) {
<OPTION value="<% $i->{id} %>"
        <% $i->{id} eq $data->{CATEGORY} ? "selected" : "" %>>
<% $i->{name} %></OPTION>
% }
</SELECT>
<TR><TD>Séma:<TD><SELECT name="scheme" onchange="<& ajax, comp => 'SELF:updateparams' &>">
% foreach ($m->comp('schemes')) {
<OPTION value="<% $_ %>"<% $_ eq $data->{SCHEME} ? "selected" : "" %>>
<& $_ . ':longname' &></OPTION>
% }
</SELECT>
<TR><TD>Szint:<TD><SELECT name="level">
% while (defined ($i = $get_levels->fetchrow_hashref)) {
<OPTION value="<% $i->{id} %>"
        <% $i->{id} eq $data->{LEVEL} ? "selected" : ""  %>>
<% $i->{name} %></OPTION>
% }
</SELECT>
</TABLE>
<P>
<DIV id="schemeparams">
<& $data->{SCHEME} . ":params", exdata => $data->{EXDATA} &>
</DIV>
<P>
<INPUT TYPE=submit NAME="<% $data->{FORM} %>"
VALUE="<% $data->{FORM} eq 'add' ? 'Felvesz' : 'Módosít' %>">
</FORM>

<%method updateparams>
<%attr>
ajax => 1
update => 'schemeparams'
form => 'exercise'
</%attr>
<%args>
$scheme
</%args>
<& $scheme . ":params", exdata => $data->{EXDATA} &>
<%init>
&session_read;
$r->content_type("text/html; charset=utf-8");
</%init>
</%method>

<%once>
my ($get_categories, $get_levels, $i);
</%once>

<%init>;
if (!defined $get_categories) {
    $get_categories =
	$dbh->prepare("SELECT id, name FROM categories
                                       ORDER BY chapter, id");
    $get_levels =
	$dbh->prepare("SELECT id, name FROM levels ORDER BY id");
}

$get_categories->execute;
$get_levels->execute;
</%init>

<%cleanup>;
$get_categories->finish;
$get_levels->finish;
</%cleanup>
