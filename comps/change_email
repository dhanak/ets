<%doc> This is a -*- mason -*- template.
Request e-mail change confirmation from user: send out email with
confirmation string, and request it in a form entry. If it is confirmed,
change e-mail.
</%doc>

<%args>
$neptun
$email
$setnewpwd => 0
</%args>

<h3 align="center">E-mail cím<% $setnewpwd ? " és jelszó" : "" %> megerősítése</h3>

A megadott új e-mail cím helyességének ellenőrzéséhez elküldtem a
<b><% $email %></b> címre egy
% if ($setnewpwd) {
frissen generált jelszót. Ezt írd be az alábbi mezőbe az e-mail cím és a
jelszó véglegesítéséhez.
% } else {
egyszerhasználatos jelszót. A változtatás véglegesítéséhez ezt a jelszót
másold be az alábbi mezőbe.
% }

<blockquote>
<& form, action => "action_change_email", hidden => { neptun => $neptun,
email => $email, hash => $hash } &>
<input type=<% $setnewpwd ? "password" : "text" %> name=password>
<input type=submit name=mehet value="Mehet!">
</form>
</blockquote>

<%once>;
use Email::Stuffer;

my ($hash, $password);
</%once>

<%init>;
$password = "";
for (1 .. 16) {
    $password .= ('A' .. 'Z', 'a' .. 'z')[int rand 52];
}
$hash = crypt($email . $password, $password);

if ($setnewpwd) {
    $m->comp('/sub/send_reminder', email => $email, password => $password);
} else {
    Email::Stuffer
        ->from($ENV{CONTACT})
        ->to($email)
        ->subject('ETS email cím megerősítése')
        ->text_body("Egyszerhasználatos jelszó az email címed megerősítéshez: $password")
        ->send_or_die;
}
</%init>
