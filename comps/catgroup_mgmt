<%doc> This is a -*- mason -*- template.
Provide a category group listing and a possibility to add, modify and
delete category groups.
</%doc>
<%attr>
window_js => 1
</%attr>

<h3 class="topic">Témacsoportok</h3>

<TABLE width="100%">
<TR>
<TH width="16">
<TH width="*">Témacsoport megnevezése
<TH width="50%">Témakörök
<TH width="16">

% $lastrank = 0;
% while (defined ($cg = $get_cgs->fetchrow_hashref)) {
<& TR, \$row &>
<TD align=center>
% if ($lastrank > 0) {
<& link, href => 'action_reorder_catgroup', img => "up.png", text => "Föl",
         params => { rank => $cg->{rank} } &>
% }
<TD><% $cg->{name} %>
<TD>
% for (split /\|/, $cg->{members}) {
<% $categories{$_} %><BR>
% }
<TD align=center>
<TABLE>
<TR height=3>
<TR>
<TD align=center>
<& link, href => "action_show_page", img => "edit.png", text => "Módosít",
    params => { catgroup => $cg->{rank}, page => "modify_catgroup_form" } &>
<TR height=3>
<TR>
<TD align=center>
<& js_confirm, img => "delete.png", text => "Töröl",
    question => "Biztosan törölni akarod a '$cg->{name}' témacsoportot?",
    action   => "action_delete_catgroup",
    hidden   => { rank => $cg->{rank} }  &>
<TR height=3>
</TABLE>

% $lastrank = $cg->{rank};
% }

<& TR, \$row &>
<& form, action => "action_add_catgroup", hidden => { rank => $lastrank+1 } &>
<TD><TD><INPUT TYPE=text NAME=name SIZE=40>
<TD colspan=3 align=center valign=middle>
<INPUT TYPE=submit NAME=submit VALUE="Felvesz">
</FORM>

</TABLE>

<%once>
my ($get_cgs, $cg, $lastrank, $get_cats, $row, $cat, %categories);
</%once>

<%init>;
if (!defined $get_cgs) {
    $get_cgs = # read list of category groups
	$dbh->prepare("SELECT rank, name, members FROM catgroups
                              ORDER BY rank");
    $get_cats = # read list of categories
	$dbh->prepare("SELECT id, name FROM categories");
}

%categories = ();
$get_cats->execute;
while (defined ($cat = $get_cats->fetchrow_hashref)) {
    $categories{$cat->{id}} = $cat->{name};
}
$get_cats->finish;

$get_cgs->execute;
$row = 0;
</%init>

<%cleanup>
$get_cgs->finish;
</%cleanup>
